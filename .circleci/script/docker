#!/usr/bin/env bash

image_tag=$(cat resources/CLJ_KONDO_VERSION)
if [[ ! $image_tag =~ SNAPSHOT$ ]]; then
    snapshot=true
else
    snapshot=false
fi

if [ -z "$CIRCLE_PULL_REQUEST" ] && [ "$CIRCLE_BRANCH" = "master" ]; then
    echo "Building Docker image $image_name:$image_tag"
    image_name="borkdude/clj-kondo"
    echo "$DOCKERHUB_PASS" | docker login -u "$DOCKERHUB_USER" --password-stdin
    docker build -t "$image_name" .
    docker tag "$image_name:latest" "$image_name:$image_tag"
    # we only update latest when it's not a SNAPSHOT version
    if [ ! $snapshot ]; then
        docker push "$image_name:latest"
    fi
    # we update the version tag, even if it's a SNAPSHOT version
    docker push "$image_name:$image_tag"
else
    echo "Not publishing Docker image"
fi


exit 0;
